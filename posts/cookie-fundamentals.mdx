---
title: Cookie Fundamentals
slug: cookie-fundamentals
tags:
  - cookie
  - security
  - javascript
date: 2021-06-16
---

[1. Introduction](https://datatracker.ietf.org/doc/html/rfc6265#section-1)

- server ç«¯åœ¨ http response headers é€é set-cookie field å°‡ cookie é€çµ¦ user agent (e.g. browser)
- user agent å‘ server ç™¼å‡º request æ™‚ï¼Œæ ¹æ“š set-cookie é™„ä¸Šçš„ cookie metadata åˆ¤æ–·æ˜¯å¦æ”¾å…¥ http request headers cookie field

>Using the Set-Cookie header field, an HTTP server can pass name/value pairs and associated metadata (called cookies) to a user agent. When the user agent makes subsequent requests to the server, the user agent uses the metadata and other information to determine whether to return the name/value pairs in the Cookie header.

[3. Overview](https://datatracker.ietf.org/doc/html/rfc6265#section-3)

- æ ¹æ“šä¸åŒ user agentï¼Œéƒ¨åˆ†å¯èƒ½æœƒå¿½ç•¥ http response status codes ç‚º 100-level (Informational responses) çš„ set-cookieã€‚
  - 100 Continue: æ­¤è‡¨æ™‚å›æ‡‰è¡¨æ˜ï¼Œç›®å‰ç‚ºæ­¢çš„ä¸€åˆ‡å®Œå¥½ï¼Œè€Œç”¨æˆ¶ç«¯æ‡‰ç•¶ç¹¼çºŒå®Œæˆè«‹æ±‚ã€æˆ–æ˜¯åœ¨å·²å®Œæˆè«‹æ±‚çš„æƒ…æ³ä¸‹ï¼Œå¿½ç•¥æ­¤è³‡è¨Šã€‚
  - 101 Switching Protocol:: æ­¤ç‹€æ…‹ç¢¼ä¹ƒç‚ºç”¨æˆ¶ç«¯ Upgrade (en-US) è«‹æ±‚æ¨™é ­ç™¼é€ä¹‹å›æ‡‰ã€ä¸”è¡¨æ˜ä¼ºæœå™¨äº¦åˆ‡æ›ä¸­ã€‚
  - 102 Processing (WebDAV): æ­¤ç‹€æ…‹ç¢¼è¡¨æ˜ä¼ºæœå™¨æ”¶åˆ°ä¸¦è™•ç†è«‹æ±‚ä¸­ï¼Œä½†ç›®å‰æœªæœ‰å›æ‡‰ã€‚
  - 103 Early Hints: æ­¤ç‹€æ…‹ç¢¼ä¸»è¦èˆ‡ Link (en-US) æ¨™é ­æœ‰é—œï¼šå®ƒèƒ½è®“ç”¨æˆ¶ä»£ç†ï¼ˆuser agentï¼‰èƒ½åœ¨ä¼ºæœå™¨æº–å‚™å›æ‡‰å‰èƒ½ preloading (en-US) è³‡æºã€‚
  - ä»¥ä¸Šå¼•ç”¨è‡ª [HTTP ç‹€æ…‹ç¢¼](https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Status)

>User agents MAY ignore Set-Cookie headers contained in responses with 100-level status codes but MUST process Set-Cookie headers contained in other responses (including responses with 400-and 500-level status codes).


[3.1. Examples](https://datatracker.ietf.org/doc/html/rfc6265#section-3.1)

- åˆªé™¤ cookie å»ºè­°åšæ³•ï¼Œå°‡ expires è¨­ç‚ºéå»æ™‚é–“

>Finally, to remove a cookie, the server returns a Set-Cookie header with an expiration date in the past.  The server will be successful in removing the cookie only if the Path and the Domain attribute in the Set-Cookie header match the values used when the cookie was created.

```
== Server -> User Agent ==

Set-Cookie: lang=; Expires=Sun, 06 Nov 1994 08:49:37 GMT

== User Agent -> Server ==

Cookie: SID=31d4d96e407aad42
```

## Set-Cookie

[4.1.1. Syntax (Set-Cookie)](https://datatracker.ietf.org/doc/html/rfc6265#section-4.1.1)

- ç‚ºäº†æœ€å¤§åŒ– user agent å…¼å®¹æ€§ï¼Œå»ºè­° server å° cookie value encodeï¼Œå¤§éƒ¨åˆ†å¥—ä»¶å°æ­¤é€²è¡Œå¯¦ä½œ

>To maximize compatibility with user agents, servers that wish to store arbitrary data in a cookie-value SHOULD encode that data, for example, using Base64 [RFC4648]

- section 5.2 ä¸­æ‰¾ä¸åˆ°ç›¸é—œèªªæ˜ï¼Œé€™è£¡å…ˆé™„ä¸Š [How to handle multiple cookies with the same name?](https://stackoverflow.com/questions/4056306/how-to-handle-multiple-cookies-with-the-same-name)

>servers SHOULD NOT produce two attributes with the same name in the same set-cookie-string.  (See Section 5.3 for how user agents handle this case.)

- js ä¸­çš„ `new Date().toUTCString()`ã€`new Date().toGTMString()` çš†ç¬¦åˆ expires çš„æ ¼å¼è¦æ ¼

>expires-av = "Expires=" sane-cookie-date <br/> sane-cookie-date  = <rfc1123-date, defined in [RFC2616], Section 3.3.1>

[rfc 2616 3.3.1](https://datatracker.ietf.org/doc/html/rfc2616#section-3.3.1)

>HTTP applications have historically allowed three different formats for the representation of date/time stamps:

>Sun, 06 Nov 1994 08:49:37 GMT  ; RFC 822, updated by RFC 1123<br/>Sunday, 06-Nov-94 08:49:37 GMT ; RFC 850, obsoleted by RFC 1036<br/>Sun Nov  6 08:49:37 1994       ; ANSI C's asctime() format

[4.1.2.2. The Max-Age Attribute](https://datatracker.ietf.org/doc/html/rfc6265#section-4.1.2.2)

- max-age ä»¥ç§’ç‚ºå–®ä½
- max-age çš„å„ªå…ˆç´šæ¯” expiresï¼Œä½†éƒ¨åˆ† user agent ä¸æ”¯æ´æ­¤å±¬æ€§

>The Max-Age attribute indicates the maximum lifetime of the cookie, represented as the number of seconds until the cookie expires.  The user agent is not required to retain the cookie for the specified duration.  In fact, user agents often evict cookies due to memory pressure or privacy concerns.

>NOTE: Some existing user agents do not support the Max-Age attribute.  User agents that do not support the Max-Age attribute ignore the attribute.

>If a cookie has both the Max-Age and the Expires attribute, the Max-Age attribute has precedence and controls the expiration date of the cookie.  If a cookie has neither the Max-Age nor the Expires attribute, the user agent will retain the cookie until "the current session is over" (as defined by the user agent).

[4.1.2.3. The Domain Attribute](https://datatracker.ietf.org/doc/html/rfc6265#section-4.1.2.3)

- çœç•¥ domain attirbuteï¼Œé è¨­æœƒä»¥ current host ç‚ºä¸»ï¼Œä¸æœƒå° subdomains ç™¼é€ cookie
- æœ‰æŒ‡å®š domainï¼Œä¹Ÿæœƒä½œç”¨åœ¨ subdomains
- å¦‚æœ domain å¸¶æœ‰ `.` å‰ç¶´ï¼Œå‰‡ `.` å­—å…ƒæœƒè¢«å¿½ç•¥
- å¦‚æœ domain å¸¶æœ‰ `.` å¾Œç¶´ï¼Œå‰‡æ­¤å±¬æ€§æœƒè¢«å¿½ç•¥

>The Domain attribute specifies those hosts to which the cookie will be sent.  For example, if the value of the Domain attribute is "example.com", the user agent will include the cookie in the Cookie header when making HTTP requests to example.com, www.example.com, and www.corp.example.com.  (Note that a leading %x2E ("."), if present, is ignored even though that character is not permitted, but a trailing %x2E ("."), if present, will cause the user agent to ignore the attribute.)  If the server omits the Domain attribute, the user agent will return the cookie only to the origin server.

[4.1.2.5. The Secure Attribute ](https://datatracker.ietf.org/doc/html/rfc6265#section-4.1.2.5)

- secure çš„å®šç¾©ç‚º user agent æ±ºå®šï¼Œé€šå¸¸ç‚º TLS

> The Secure attribute limits the scope of the cookie to "secure" channels (where "secure" is defined by the user agent). When a cookie has the Secure attribute, the user agent will include the cookie in an HTTP request only if the request is transmitted over a secure channel (typically HTTP over Transport Layer Security (TLS)[RFC2818]).

[4.1.2.6. The HttpOnly Attribute](https://datatracker.ietf.org/doc/html/rfc6265#section-4.1.2.6)

- ç„¡æ³•é€éé http api ä»¥å¤–çš„æ–¹å¼å–å¾—ï¼Œä¾‹å¦‚ `document.cookie`

>The HttpOnly attribute limits the scope of the cookie to HTTP requests.  In particular, the attribute instructs the user agent to omit the cookie when providing access to cookies via "non-HTTP" APIs (such as a web browser API that exposes cookies to scripts).

[MDN Set-Cookie#syntax](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#syntax)

```
Set-Cookie: <cookie-name>=<cookie-value>
Set-Cookie: <cookie-name>=<cookie-value>; Expires=<date>
Set-Cookie: <cookie-name>=<cookie-value>; Max-Age=<non-zero-digit>
Set-Cookie: <cookie-name>=<cookie-value>; Domain=<domain-value>
Set-Cookie: <cookie-name>=<cookie-value>; Path=<path-value>
Set-Cookie: <cookie-name>=<cookie-value>; Secure
Set-Cookie: <cookie-name>=<cookie-value>; HttpOnly

Set-Cookie: <cookie-name>=<cookie-value>; SameSite=Strict
Set-Cookie: <cookie-name>=<cookie-value>; SameSite=Lax
Set-Cookie: <cookie-name>=<cookie-value>; SameSite=None; Secure

// Multiple attributes are also possible, for example:
Set-Cookie: <cookie-name>=<cookie-value>; Domain=<domain-value>; Secure; HttpOnly
```

### SameSite Attribute

declare if your cookie should be restricted to a first-party or same-site context.

é™åˆ¶ cookie æ˜¯å¦åƒ…åœ¨ç¬¬ä¸€æ–¹ç’°å¢ƒä½œç”¨

- Strict: å®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹ 
- Lax: å…è¨±éƒ¨åˆ† html æ¨™ç±¤ç™¼é€ç¬¬ä¸‰æ–¹ cookieï¼Œchrome80+ å¾Œä½œç‚ºé è¨­å€¼ï¼Œå…è¨±æƒ…æ³æœ‰
  - `<a>`
  - `<link rel="prerender">`
  - `<form method="GET">`
- None: åœ¨ secure ç’°å¢ƒä¸‹é–‹æ”¾ç¬¬ä¸‰æ–¹
  - the cookie Secure attribute must also be set (or the cookie will be blocked)

ä¸»æµçš„å»£å‘Šè¿½è¹¤åƒæ˜¯ google analytics, pixel, amplitude, etc éƒ½æ˜¯æ¡ç”¨ç¬¬ä¸€æ–¹ cookieï¼Œæ„å³ä½ æœƒåœ¨ app ä¸­åŠ å…¥å»£å‘Šå•†æä¾›çš„ç¨‹å¼ç¢¼ï¼Œè©²ç¨‹å¼ç¢¼ç”¢ç”Ÿè¿½è¹¤ç”¨çš„ç¬¬ä¸€æ–¹ cookie (first-party)ï¼Œæ‰€ä»¥ SameSite å±¬æ€§å°å»£å‘Šè¿½è¹¤ç›¸é—œçš„å½±éŸ¿ä¸¦ä¸å¤§

## Cookie

[4.2.1. Syntax (Cookie)](https://datatracker.ietf.org/doc/html/rfc6265#section-4.2.1)

>The user agent sends stored cookies to the origin server in the Cookie header.  If the server conforms to the requirements in Section 4.1 (and the user agent conforms to the requirements in Section 5), the user agent will send a Cookie header that conforms to the following grammar:

> cookie-header = "Cookie:" OWS cookie-string OWS<br/>cookie-string = cookie-pair *( ";" SP cookie-pair )

[4.2.2. Semantics (Cookie)](https://datatracker.ietf.org/doc/html/rfc6265#section-4.2.2)

>Each cookie-pair represents a cookie stored by the user agent.  The cookie-pair contains the cookie-name and cookie-value the user agent received in the Set-Cookie header.

>Notice that the cookie attributes are not returned.  In particular, the server cannot determine from the Cookie header alone when a cookie will expire, for which hosts the cookie is valid, for which paths the cookie is valid, or whether the cookie was set with the Secure or HttpOnly attributes.

- http cookie ä¸åŒ…å« attirbutes
- server ç„¡æ³•å–®å¾ attributes è¡¡é‡ cookie æ˜¯å¦æœ‰æ•ˆ
- cookie ä¹‹é–“ä»¥ `; ` (";" SP) åšç‚ºåˆ†éš” e.g. `foo=bar; hi=there`

## Document.cookie

- javascript access http cookie (client-side)
- `document` çš„ `cookie` ç‚ºä¸€å€‹å¸¶æœ‰ getter, setter çš„å±¬æ€§ï¼Œèˆ‡ä¸€èˆ¬å±¬æ€§çš„è®€ã€å¯«ä¸åŒ
- `document.cookie` : å–å¾—æ‰€æœ‰å¯ç”¨ cookieï¼Œæ ¼å¼ç‚º cookie-pair *( ";" SP cookie-pair )
- `document.cookie = newCookie` : `newCookie` æ ¼å¼å¯åƒè€ƒ set-cookie syntax

>The Document property cookie lets you read and write cookies associated with the document. It serves as a getter and setter for the actual values of the cookies.

## Cookie-related Modules

åƒè€ƒ npm ä¸Š cookie ç›¸é—œçš„å¥—ä»¶å¯¦ä½œ

[jshttp/cookie](https://github.com/jshttp/cookie/blob/master/index.js)

```js
const cookie = require('cookie');
const escapeHtml = require('escape-html');
const http = require('http');

function onRequest(req, res) {
  // Parse the cookies on the request
  const cookies = cookie.parse(req.headers.cookie || '');
  const foo = cookie.serialize('foo', 'bar', {
    path: '/',
    secure: true,
    expires: new Date(new Date().setDate(new Date().getDate() + 7)),
  });
  // 'foo=bar; Path=/; Secure; Expires=Wed, 23 Jun 2021 20:41:50 GMT'
  res.setHeader('Set-Cookie', foo);
}

http.createServer(onRequest).listen(3000);
```

parse cookie

```js
function parse(cookieString, options = {}) {
  if (typeof cookieString !== 'string') {
    return;
  }

  const decode = options.decode || encodeURIComponent;
  const splitReg = ;
  const cookiePairs = cookieString.split(/; */);
  
  return cookiePairs.reduce((acc, pair) => {
    const equalIndex = pair.indexOf('=');

    if (equalIndex < 0) {
      return;
    }
    
    const name = pair.substr(0, equalIndex).trim();
    const value = pair.substr(equalIndex + 1, pair.length);
    
    if (!acc[name]) {
      const valueStartWithQuote = value[0] === '"';
      acc[name] = valueStartWithQuote ? value.slice(1, -1) : value;
    }
    
    return acc;
  }, {});
}
```

serialize data into cookie header

- field-content: rfc 7230 sec 3.2 æˆ‘çœ‹ä¸æ‡‚ï¼Œå…ˆé™„ä¸Š regexp å°ç…§
  - `\u0009`: tab character (\t)
  - `\u0020-\u007e`: char code 32 to 126
  - `\u0080-\u00ff`: char code 128 to 255
- å› ç‚ºéƒ¨åˆ† set-cookie syntax å¯¦ä½œå·®ç•°ä¸å¤§ï¼Œæ‰€ä»¥åœ¨ä¸‹æ–¹ç¨‹å¼ç¢¼ä¸­çœç•¥ï¼Œåƒæ˜¯ max-age, http-only ... ç­‰å±¬æ€§

```js
/**
 * RegExp to match field-content in RFC 7230 sec 3.2
 *
 * field-content = field-vchar [ 1*( SP / HTAB ) field-vchar ]
 * field-vchar   = VCHAR / obs-text
 * obs-text      = %x80-FF
 */
const fieldContentRegExp = /^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;

function serialize(name, value, options = {}) {
  const decode = options.decode || encodeURIComponent;
  let string = `${name}=${value}`;
  
  if (options.expires) {
    if (typeof options.expires.toUTCString !== 'function') {
      throw new TypeError('option expires is invalid');
    }

    string += '; Expires=' + options.expires.toUTCString();
  }
  
  if (options.path) {
    if (!fieldContentRegExp.test(options.path)) {
      throw new TypeError('option path is invalid');
    }

    string += '; Path=' + options.path;
  }
  
  if (opt.secure) {
    string += '; Secure';
  }
  
  // skip
  return string;
}
```

å¦‚æœæœ‰é–‹ç™¼ server-side-rendering çš„å°ˆæ¡ˆï¼Œæ‡‰è©²æœ‰æ¥è§¸éä¸‹åˆ—çš„é¡ä¼¼å¥—ä»¶

- [universal-cookie](https://github.com/reactivestack/cookies/tree/master/packages/universal-cookie#readme)
- [cookie-universal](https://github.com/microcipcip/cookie-universal)

ä¸Šè¿°å…©æ¬¾éƒ½æ˜¯åŸºæ–¼ jshttp/cookie æ‰€å»¶ä¼¸çš„å¥—ä»¶

universal çš„æ¦‚å¿µå°±æ˜¯å¤šåˆ¤æ–·äº†ç•¶å‰çš„ç’°å¢ƒï¼Œå†æ ¹æ“šç‚º browser/server å° cookie åš read/write çš„æ“ä½œï¼Œä¾‹å¦‚

```js
module.exports = (req, res) => {
  const isClient =  typeof document === 'object' 
    && typeof document.cookie === 'string';

  const isServer = typeof req === 'object'
    && typeof res === 'object'
    && typeof module !== 'undefined';
}
```

å°è£åˆªé™¤ cookie api ä¹Ÿæ˜¯ä¾ç…§ rfc çš„å»ºè­°ï¼Œå° cookie æ•ˆæœŸçš„ä¿®æ”¹ï¼Œä¾‹å¦‚

```js
import cookie from 'cookie';

function remove(name, value, options = {}) {
  const setCookieString = cookie.serialize({
    ...options,
    maxAge: 0,
    expires:  new Date(1970, 1, 1, 0, 0, 1),
  });

  if (isClient) {
    document.cookie = setCookieString;    
  } else {
    req.setHeader('Set-Cookie', setCookieString);
  }
}
```

ä¸Šè¿°éƒ½åªæ˜¯ç¤ºæ„ç”¨çš„ç¨‹å¼ç¢¼ï¼Œè©³ç´°å¯åƒè€ƒ [universal-cookie](https://github.com/reactivestack/cookies/blob/master/packages/universal-cookie/src/Cookies.ts#L81-L96)

## Reference

[ç¶²ç«™å®‰å…¨ğŸ”’ å†æ¢åŒæºæ”¿ç­–ï¼Œè«‡ SameSite è¨­å®šå° Cookie çš„å½±éŸ¿èˆ‡æ³¨æ„äº‹é …](https://medium.com/%E7%A8%8B%E5%BC%8F%E7%8C%BF%E5%90%83%E9%A6%99%E8%95%89/%E5%86%8D%E6%8E%A2%E5%90%8C%E6%BA%90%E6%94%BF%E7%AD%96-%E8%AB%87-samesite-%E8%A8%AD%E5%AE%9A%E5%B0%8D-cookie-%E7%9A%84%E5%BD%B1%E9%9F%BF%E8%88%87%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85-6195d10d4441)

[MDN - Set-Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie)

[How to handle multiple cookies with the same name?](https://stackoverflow.com/questions/4056306/how-to-handle-multiple-cookies-with-the-same-name)

[jshttp/cookie](https://github.com/jshttp/cookie)

[MDN Docuemnt.cookie](https://developer.mozilla.org/en-US/docs/Web/API/Document/cookie)

[MDN SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite#browser_compatibility)
